atabase Multi-Tenancy Fix Implementation Plan                                                                                                                                                            │ │
│ │                                                                                                                                                                                                           │ │
│ │ Critical Issue Identified                                                                                                                                                                                 │ │
│ │                                                                                                                                                                                                           │ │
│ │ The database has a fundamental schema flaw where location.code has a global unique constraint instead of per-warehouse uniqueness. This breaks multi-tenancy and causes "duplicate data" errors when      │ │
│ │ creating warehouses with standard location codes.                                                                                                                                                         │ │
│ │                                                                                                                                                                                                           │ │
│ │ Root Cause Analysis                                                                                                                                                                                       │ │
│ │                                                                                                                                                                                                           │ │
│ │ - models.py:246: code = db.Column(db.String(50), unique=True, nullable=False)                                                                                                                             │ │
│ │ - Location codes like "RECEIVING", "01-01-001A" can only exist once across ALL warehouses                                                                                                                 │ │
│ │ - Current workarounds only delete from same warehouse, don't solve cross-warehouse conflicts                                                                                                              │ │
│ │ - Migration script already exists but hasn't been executed                                                                                                                                                │ │
│ │                                                                                                                                                                                                           │ │
│ │ Phase 1: Execute Database Migration (Critical - 1 week)                                                                                                                                                   │ │
│ │                                                                                                                                                                                                           │ │
│ │ 1. Run existing migration: backend/src/migrations/fix_location_uniqueness.py                                                                                                                              │ │
│ │   - Drops global UNIQUE(code) constraint                                                                                                                                                                  │ │
│ │   - Creates UNIQUE(warehouse_id, code) compound constraint                                                                                                                                                │ │
│ │   - Safe data migration with rollback capability                                                                                                                                                          │ │
│ │ 2. Update models.py constraint definition:                                                                                                                                                                │ │
│ │   - Remove unique=True from code field                                                                                                                                                                    │ │
│ │   - Add __table_args__ with compound unique constraint                                                                                                                                                    │ │
│ │   - Update indexes for performance optimization                                                                                                                                                           │ │
│ │                                                                                                                                                                                                           │ │
│ │ Phase 2: Remove Workaround Code (1 week)                                                                                                                                                                  │ │
│ │                                                                                                                                                                                                           │ │
│ │ 1. Clean warehouse_api.py: Remove force_recreate global deletion logic                                                                                                                                    │ │
│ │ 2. Update virtual_template_integration.py: Remove constraint violation workarounds                                                                                                                        │ │
│ │ 3. Test multi-warehouse creation: Verify proper tenant isolation                                                                                                                                          │ │
│ │                                                                                                                                                                                                           │ │
│ │ Phase 3: Long-term Multi-tenancy (2-3 weeks)                                                                                                                                                              │ │
│ │                                                                                                                                                                                                           │ │
│ │ 1. Implement UserWarehouseAccess: Proper user-warehouse permissions                                                                                                                                       │ │
│ │ 2. Add tenant middleware: Automatic warehouse context resolution                                                                                                                                          │ │
│ │ 3. Create comprehensive tests: Multi-tenant scenarios validation                                                                                                                                          │ │
│ │                                                                                                                                                                                                           │ │
│ │ Success Criteria                                                                                                                                                                                          │ │
│ │                                                                                                                                                                                                           │ │
│ │ - Multiple warehouses can have same location codes (e.g., both have "RECEIVING")                                                                                                                          │ │
│ │ - Warehouse setup wizard works without force_recreate workarounds                                                                                                                                         │ │
│ │ - Template application succeeds across different warehouses                                                                                                                                               │ │
│ │ - Database supports unlimited warehouse scaling                                                                                                                                                           │ │
│ │                                                                                                                                                                                                           │ │
│ │ This fixes the fundamental architectural flaw preventing proper multi-tenancy and eliminates the technical debt causing current warehouse setup failures.             